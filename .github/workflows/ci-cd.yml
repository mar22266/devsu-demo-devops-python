deploy:
  needs: docker-build-and-push
  runs-on: self-hosted
  if: github.ref == 'refs/heads/main'

  steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up kubectl
      uses: azure/setup-kubectl@v4
      with:
        version: "v1.34.0"

    - name: Apply Kubernetes manifests to local minikube
      env:
        IMAGE_TAG: ${{ github.sha }}
        REGISTRY: ghcr.io
      run: |
        IMAGE=${REGISTRY}/${GITHUB_REPOSITORY}:${IMAGE_TAG}

        echo "Usando imagen: $IMAGE"

        # Reemplazar placeholder de la imagen en el deployment
        sed -i "s|IMAGE_PLACEHOLDER|$IMAGE|g" k8s/deployment.yaml

        # Aplicar manifiestos usando el kubeconfig local (~/.kube/config)
        kubectl apply -f k8s/namespace.yaml
        kubectl apply -f k8s/configmap.yaml
        kubectl apply -f k8s/secret.yaml
        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/service.yaml
        kubectl apply -f k8s/ingress.yaml
        kubectl apply -f k8s/hpa.yaml

    - name: Show rollout status
      run: |
        kubectl -n devsu-demo rollout status deployment/devsu-python-api
        kubectl -n devsu-demo get pods,svc,ingress
